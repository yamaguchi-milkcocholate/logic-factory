# Python Coding Standards - Logic Factory Style

## 1. プロジェクト構造と依存関係管理

- **ツール**: パッケージ管理には `uv` を必須とする。
- **構成**: `apps/{app_name}/` ごとに `pyproject.toml` を配置し、依存関係を完全に隔離する。
- **共有ロジック**: 複数アプリで使う処理（APIクライアント、動画生成ヘルパー）は `shared/python/` に配置し、各アプリから `editable install` または `PYTHONPATH` 経由で参照する。

## 2. 実装スタイル (Modern Python)

- **非同期ファースト**:
  - API連携、DB操作、スクレイピングは原則 `asyncio` を使用。
  - HTTP クライアントは `httpx` を使用し、`requests` は非推奨とする。
- **厳格な型ヒント**:
  - `typing` (or `collections.abc`) を活用し、`Any` の使用を極力避ける。
  - `mypy --strict` または `Pyright` の最高強度でエラーが出ない構成を目指す。
- **データバリデーション**:
  - 外部 API（Dify, Gemini等）からのレスポンスは必ず `Pydantic` モデルでパースし、型安全なオブジェクトとして扱う。

## 3. ロジック設計指針

- **冪等性 (Idempotency) の担保**:
  - 途中でエラーが起きても再実行すれば正常終了するよう設計する（特に動画生成やSNS投稿）。
- **ロギング**:
  - `loguru` を使用。構造化ログを出力し、n8n側でエラー検知しやすい形式にする。
  - 「なぜこの判断（バイアス判定）をしたか」の推論プロセスをデバッグログに残す。
- **設定管理**:
  - `pydantic-settings` を使用。`.env` の読み込み、型チェック、デフォルト値設定を自動化する。

## 4. エラーハンドリング

- **防御的プログラミング**: 外部 LLM API のタイムアウトやレートリミットを想定し、`tenacity` 等を用いたリトライ戦略を標準搭載する。

## 5. テスト・品質管理

- **ドキュメント**: Google Style Docstring を基本とするが、特に「AIへの指示内容」や「プロンプトの意図」をコード内にコメントとして残す。
- **静的解析**: `ruff` を使用。Lint（ルール遵守）と Format（整形）を自動化し、PR作成前に必ず実行する。
